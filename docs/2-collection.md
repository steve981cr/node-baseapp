# Add an Articles Collection to the base app.
* These are the instructions that were used to add an articles collection to this app. 
* You can recreate it by following these instructions.
* We will persist the data with a SQLite database. You can switch it out for MySQL or Postgres.
* We will use the Sequelize ORM package.
* We will use express-validator to validate/sanitize form data.

---
## Installation and configuration
```npm install sequelize sqlite3 express-validator```  
* Sequelize has a CLI tool called sequelize-cli. You can either install it as a local development dependency, install it globally, or not install it at all and run it with npx.  
To install it globally: `npm i -g sequelize-cli`  
* Generate the file structure: `sequelize init`  
This creates folders/files for sequelize config, models, migrations, and seeders.
* Modify the config/config.json file for SQLite. See file for the configuration.

---
## Generate a model
* The articles collection will have fields for title, content, published, and autogenerated fields for id, createAt, and updatedAt.
* Run the sequelize-cli command to generate a model and migration file:  
```
sequelize model:generate --name Article --attributes title:string,content:text,published:boolean
```
* Run the migration file to add the table to the database:
```
sequelize migrate:db
```
* Generate a seed file to add records to the DB:
```
sequelize seed:generate --name seed-article
```
* Add articles to the seeder file. See seeders/*YYYYMMDDHHMMSS*-seed-article.js
* Run the seeder file:
```
sequelize db:seed:all
```

---
## Routes
* Import the controller file and add the routes for the Articles collection.
* The get() method serves GET requests for HTML pages. 
  * GET requests include HTML pages for:
    * List of all articles, or a filtered list of articles.
    * Details showing a specific article.
    * Forms pages to Create, Update, and Delete an article.
  * POST requests to post data to Create, Update, and Delete an article.
    * HTML forms can only send POST requests.
``` JavaScript
// routes/index.js
const articlesController = require('../controllers/articlesController');
...
// Articles routes
router.get('/articles', articlesController.list);
router.get('/articles/create', articlesController.createForm);
router.post('/articles/create', articlesController.validateForm, articlesController.create);
router.get('/articles/:id', articlesController.details);
router.get('/articles/:id/update', articlesController.updateForm);
router.post('/articles/:id/update', articlesController.validateForm, articlesController.update);
router.get('/articles/:id/delete', articlesController.deleteForm);
router.post('/articles/:id/delete', articlesController.delete);
```

---
## Controller setup
* Add a controller file: `touch controllers/articlesController.js`
* At the top import the Article model, the http-errors package to format errors for http responses, and express-validator to validate and/or sanitize form data.
```
const { Article } = require('../models');
const createError = require('http-errors');
const { body, validationResult } = require('express-validator');
```
---
## Views setup
* Add a view folder and files for the articles.
```
mkdir views/articles
touch views/articles/list.ejs
touch views/articles/details.ejs
touch views/articles/create.ejs
touch views/articles/update.ejs
touch views/articles/delete.ejs
```
---
## List Route, Controller Function, View
### Route
* GET Requests to /articles are handled by the controller list function.
```
router.get('/articles', articlesController.list);
```
### Controller List Function
* Wrap the query in a try/catch block. That way if there is an error the catch clause will handle it. 
* Query the database using the Sequelize findAll() function chained to the Article model.
  * All database queries are asynchronous, so add await so the function will wait for the results before going to the next statement.
  * Optionally include a where clause to only find published articles.
  * Order the articles by createdAt date in descending order.
  * Sequelize ORM will query the database and convert the results into an array of article objects.
* Render the list view template, passing in a variables object containing the title and articles array from the database.
* If there is an error catch it, then log it to the console.
  * Call the next() method passing in the error object as the argument. Express will then pass it to the error handling function at the bottom of the app.js file and display the error HTML page.
``` JavaScript
exports.list = async (req, res, next) => {
  try {
    const articles = await Article.findAll({ 
      // where: {published: true},
      order: [['createdAt', 'DESC']]
    });    
    res.render('articles/list', { title: 'Articles', articles: articles });
  } catch (err) {
    console.log('Error querying articles', JSON.stringify(err))
    return next(err);
  }
};
```
### List View
* See the views/articles/list.ejs file for the HTML and EJS code.
* At the top is a button link to the Create article form.
* Iterate over the articles array displaying each article title with a link to the article detail page.
* You can display the results as an unordered list, an ordered list, a description list, a table, or some other format. 
* The example uses an Unordered list, but has commented out code for a description list and a table. 


---
## Detail Route, Controller Function, View
### Route
* GET Requests to /articles/:id are handled by the controller details function.
```
router.get('/articles/:id', articlesController.details);
```
### Controller Details Function