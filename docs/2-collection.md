# Add an Articles Collection to the base app.
* These are the instructions that were used to add an articles collection to this app. 
* You can recreate it by following these instructions.
* We will persist the data with a SQLite database. You can switch it out for MySQL or Postgres.
* We will use the Sequelize ORM package.
* We will use express-validator to validate/sanitize form data.

---
## Installation and configuration
```npm install sequelize sqlite3 express-validator```  
* Sequelize has a CLI tool called sequelize-cli. You can either install it as a local development dependency, install it globally, or not install it at all and run it with npx.  
To install it globally: `npm i -g sequelize-cli`  
* Generate the file structure: `sequelize init`  
This creates folders/files for sequelize config, models, migrations, and seeders.
* Modify the config/config.json file for SQLite. See file for the configuration.

---
## 1) Generate a model and add table to the DB
* The articles collection will have fields for title, content, published, and autogenerated fields for id, createAt, and updatedAt.
* 1a) Run the sequelize-cli command to generate a model and migration file:  
```
sequelize model:generate --name Article --attributes title:string,content:text,published:boolean
```
* 1b) Make modifications to the migration file if necessary. For example, you could set a default value to true to the published field. `n`
* 1c) Run the migration file to add the table to the database:
```
sequelize migrate:db
```
### 1.2) Modify the Model files if necessary.
* We'll leave the model as is, but you could do something like set the default value of published to true.
``` javascript
// models/article.js
...
Article.init({
  title: DataTypes.STRING,
  content: DataTypes.STRING,
  published: {
    type: DataTypes.BOOLEAN,
    defaultValue: true,
  }
}
...
```

### 1.3) Generate a seed file to add records to the DB:
* 1.3a) Generate the seeder file.  
`sequelize seed:generate --name seed-article`
* 1.3b) Add articles to the seeder file. See seeders/*YYYYMMDDHHMMSS*-seed-article.js
* 1.3c) Run the seeder file:  
`sequelize db:seed:all`

---
## 2) Routes
* Import the controller file and add the routes for the Articles collection.
* The get() method serves GET requests for HTML pages. 
  * GET requests include HTML pages for:
    * List of all articles, or a filtered list of articles.
    * Details showing a specific article.
    * Forms pages to Create, Update, and Delete an article.
  * POST requests to post data to Create, Update, and Delete an article.
    * HTML forms can only send POST requests.
``` JavaScript
// routes/index.js
const articlesController = require('../controllers/articlesController');
...
// Articles routes
router.get('/articles', articlesController.list);
router.get('/articles/create', articlesController.createForm);
router.post('/articles/create', articlesController.validateForm, articlesController.create);
router.get('/articles/:id', articlesController.details);
router.get('/articles/:id/update', articlesController.updateForm);
router.post('/articles/:id/update', articlesController.validateForm, articlesController.update);
router.get('/articles/:id/delete', articlesController.deleteForm);
router.post('/articles/:id/delete', articlesController.delete);
```

---
## 3) Controller setup
* Add a controller file: `touch controllers/articlesController.js`
* At the top import the Article model, the http-errors package to format errors for http responses, and express-validator to validate and/or sanitize form data.
``` JavaScript
const { Article } = require('../models');
const createError = require('http-errors');
const { body, validationResult } = require('express-validator');
```
---
## 4) Views setup
* Add a view folder and files for the articles.
```
mkdir views/articles
touch views/articles/list.ejs
touch views/articles/details.ejs
touch views/articles/create.ejs
touch views/articles/update.ejs
touch views/articles/delete.ejs
```
---
## 3&4.1) List Route, Controller Function, View
### Route
* GET Requests to /articles are handled by the controller list function.
``` JavaScript
router.get('/articles', articlesController.list);
```
### Controller List Function
``` JavaScript
// GET /articles
exports.list = async (req, res, next) => {
  try {
    const articles = await Article.findAll({ 
      // where: {published: true},
      attributes: ['id', 'title', 'published', 'createdAt'],
      order: [['createdAt', 'DESC']]
    });    
    res.render('articles/list', { title: 'Articles', articles: articles });
  } catch (err) {
    console.log('Error querying articles', JSON.stringify(err))
    return next(err);
  }
};
```
* Wrap the query in a try/catch block. That way if there is an error the catch clause will handle it. 
* Query the database using the Sequelize findAll() function chained to the Article model.
  * All database queries are asynchronous, so add await so the function will wait for the results before going to the next statement.
  * Optionally include a where clause to only find published articles.
  * The attributes property specifies which attributes to pull. For the list page we are excluding the content attribute.
  * Order the articles by createdAt date in descending order.
  * Sequelize ORM will query the database and convert the results into an array of article objects.
* Render the list view template, passing in a variables object containing the title and articles array from the database.
* If there is an error catch it, then log it to the console.
  * Call the next() method passing in the error object as the argument. Express will then pass it to the error handling function at the bottom of the app.js file and display the error HTML page.

### List View
* See the views/articles/list.ejs file for the HTML and EJS code.
* At the top is a button link to the Create article form.
* Iterate over the articles array displaying each article title with a link to the article detail page.
* You can display the results as an unordered list, an ordered list, a description list, a table, or some other format. 
* The example uses an Unordered list, but has commented out code for a description list and a table. 


---
## 3&4.2) Detail Route, Controller Function, View
### Route
* GET Requests to /articles/:id are handled by the controller details function.
* :id is a route parameter. It can be accessed in the controller from the request params property `req.params.id`.
``` JavaScript
router.get('/articles/:id', articlesController.details);
```
### Controller Details Function

``` JavaScript
// controllers/articlesController.js
exports.details = async (req, res, next) => { 
  try {
    const article = await Article.findByPk(req.params.id);
    if (!article) {
      return next(createError(404));
    }
    res.render('articles/details', { title: 'Article', 
      article: article });    
  } catch (err) {
    return next(err);    
  }
};
```
* The details controller function pulls the article from the database and renders the details template.
* Call the Sequelize findByPk() method passing in the article id, which is the primary key.
* Sequelize methods are asynchronous so use the await keyword to wait for the result before moving on to the next statement.
* If there is no article found then call the next() middleware function, passing in a 404 Not Found error. If there is an argument in next() Express treats it as an error object and passes it to the error handler middleware.
* If an article is found, render the articles/details template file. Pass it the article object.
* The details function is in a try/catch block. If there is an error, other than the 404, the catch block will catch it and pass it to next(err).

### List View
* See the views/articles/details.ejs file for the HTML and EJS code.
* At the top is a button link to the Create article form.
* Iterate over the articles array displaying each article title with a link to the article detail page.
* You can display the results as an unordered list, an ordered list, a description list, a table, or some other format. 
* The example uses an Unordered list, but has commented out code for a description list and a table. 

---
## 3&4.3) Create Routes, Controller Functions, Form View
### Route
* GET Requests to /articles/:id are handled by the controller details function.
* :id is a route parameter. It can be accessed in the controller from the request params property `req.params.id`.
``` JavaScript
router.get('/articles/:id', articlesController.details);
```
### Controller createForm Function

* User clicks the link to the Create Article form (a GET request):
### Route: 
``` JavaScript
router.get('/articles/create', articlesController.createForm);
```
### Controller Callback Function:
``` JavaScript
// GET /articles/create
exports.createView = (req, res, next) => {
  res.render('articles/create', { title: 'Create Article' });
};
```
User fills out form and hits the submit button (a POST request with form data):
### Route: 
``` JavaScript
router.post('/articles/create', articlesController.validateForm, articlesController.create);
```
### Controller Callback Function:
``` JavaScript
// POST /articles/create
exports.create = async (req, res, next) => {
  // Check request's validation result. Wrap errors in an object.
  const errors = validationResult(req);
  if (!errors.isEmpty()) {
    return res.render('articles/create', 
      { article: req.body, errors: errors.array() });
  }
  try {
    const article = await Article.create(req.body);
    res.redirect(`/articles/${article.id}`);    
  } catch (err) {
    return next(err);    
  }
};
```
### For Update and Delete see the controller functions and the views.